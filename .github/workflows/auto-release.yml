name: Auto Release & Promote to Prod

on:
  push:
    branches:
      - develop # Gatilho: Quando um PR de feature √© mergeado na develop

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write      # Para criar branches
      pull-requests: write # Para abrir PRs

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Necess√°rio para hist√≥rico do Git

      - name: Configure Git Bot
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Cut Release Branch
        id: create_release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Gera uma vers√£o baseada em Data/Hora (Ex: v20240520-1430)
          VERSION="v$(date +'%Y%m%d-%H%M')"
          BRANCH_NAME="release/$VERSION"
          
          echo "üöÄ Iniciando cria√ß√£o da release: $BRANCH_NAME"

          # 1. Cria a branch de release a partir da develop atual
          git checkout -b $BRANCH_NAME
          
          # 2. Envia a branch para o GitHub
          # IMPORTANTE: Esse push vai acionar o 'deploy.yml' automaticamente,
          # fazendo o deploy no ambiente de STAGING.
          git push origin $BRANCH_NAME

          echo "‚úÖ Branch de Release criada e enviada. Deploy de Staging iniciado."
          
          # 3. Abre o PR para a Main (Produ√ß√£o)
          # O PR fica esperando sua aprova√ß√£o manual.
          echo "üîÄ Abrindo PR para Produ√ß√£o..."
          
          gh pr create \
            --base main \
            --head $BRANCH_NAME \
            --title "Release $VERSION [Staging -> Prod]" \
            --body "ü§ñ **Automa√ß√£o de Release**
            
            1. O c√≥digo da develop foi promovido para a branch \`$BRANCH_NAME\`.
            2. O ambiente de **STAGING** est√° sendo atualizado agora.
            3. **A√á√ÉO:** Teste em Staging. Se estiver tudo ok, aprove este PR para fazer o deploy em **PRODU√á√ÉO**."